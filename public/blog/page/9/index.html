
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Blog.XDite.net</title>
  <meta name="author" content="xdite">

  
  <meta name="description" content="                  Rails 101 - 火速學會 Ruby on Rails因為聖誕節，所以再度特價 XDUSD $4.99 限時一週 2011/12/19~2011/12/26http://rails-101.logdown.com/  ">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="fb:admins" content="577398551" />

  
  <link rel="canonical" href="http://blog.xdite.net/blog/page/9/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/xxddite" rel="alternate" title="Blog.XDite.net" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

-->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/"><img src="/images/h1.png" alt="Blog.XDite.net"></a></h1>
  
    <h2>Ruby / Rails / Web Development</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/xxddite" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.xdite.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/talks"> Talks</a></li>
  <li><a href="http://rails-101.logdown.com" target="_blank">Books</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/posts/2011/12/19/rails-101-xmas/">Rails 101 聖誕限時特價</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2011-12-19T11:55:00+08:00" pubdate  data-updated="true" >Dec 19<span>th</span>, 2011</time>
        
         | <a href="/posts/2011/12/19/rails-101-xmas/#disqus_thread">Comments</a>
        

      </p>
    
  </header>


  <div class="entry-content">
    
      <div class="FacebookLikeButton"><div class="fb-like" data-href="http://blog.xdite.net/posts/2011/12/19/rails-101-xmas/" data-show-faces="false"></div></div>
    
    <p>Rails 101 - 火速學會 Ruby on Rails</p>

<p>因為聖誕節，所以再度特價 XD</p>

<p>USD $4.99 限時一週 2011/12/19~2011/12/26</p>

<p><img src="http://rails-101.logdown.com/images/rails-101-cover.png" alt="Rails-101" /></p>

<p><a href="http://rails-101.logdown.com/">http://rails-101.logdown.com/</a></p>

  </div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/posts/2011/12/10/github-flavored-ruby/">Github Flavored Ruby - by Tom Preston-Werner (1)</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2011-12-10T11:23:00+08:00" pubdate  data-updated="true" >Dec 10<span>th</span>, 2011</time>
        
         | <a href="/posts/2011/12/10/github-flavored-ruby/#disqus_thread">Comments</a>
        

      </p>
    
  </header>


  <div class="entry-content">
    
      <div class="FacebookLikeButton"><div class="fb-like" data-href="http://blog.xdite.net/posts/2011/12/10/github-flavored-ruby/" data-show-faces="false"></div></div>
    
    <p>這是我近期裡面看到算比較有趣的演講，是 Github CTO Tom Preston-Werner 給的 talk</p>

<p>影片在這裡：
<a href="http://confreaks.net/videos/712-rubyconf2011-github-flavored-ruby">http://confreaks.net/videos/712-rubyconf2011-github-flavored-ruby</a></p>

<p>投影片在這裡：
<a href="http://speakerdeck.com/u/mojombo/p/github-flavored-ruby">http://speakerdeck.com/u/mojombo/p/github-flavored-ruby</a></p>

<p>本來先貼在社群內 <a href="http://ruby-taiwan.org/topics/69">http://ruby-taiwan.org/topics/69</a>。現在來補充貼我自己的筆記…</p>

<p>裡面提到非常多有趣的東西。</p>

<p>提到五個 Github 的開發哲學：</p>

<ul>
<li>Relentless Modularization</li>
<li>Readme Driven Development</li>
<li>Rake Gem</li>
<li>TomDoc</li>
<li>Semantic Version</li>
</ul>


<p>雖然這個 talk 長度不到一個小時，但是從中不少學到知識。</p>

<h2>Relentless Modularization</h2>

<p>當專案越來越大，身處其中的開發者就會越來越感覺到 codebase 帶來的壓力， code 會變得越來越 messay 和 tightly coupled。牽一髮而動全身。</p>

<p>把一些元件 modularize 應該會是好的解法。但我們總會困惑，那什麼東西應該是應該被 modularize ？</p>

<p>TOM 給出的答案：<strong>EVERYTHING</strong>。</p>

<p>Github 是這樣做的，當它們在建造 <a href="http://github.com">http://github.com</a> 時，因為 Github 是個 git services。
於是他們造了</p>

<ul>
<li>grit <a href="https://github.com/mojombo/grit">https://github.com/mojombo/grit</a></li>
</ul>


<p>接著他們為了要 scale up，造了</p>

<ul>
<li>smoke，讓 frontend 可以直接跟 backend 溝通。</li>
</ul>


<p><code>We then replace Grit::Git with a stub that makes RPC calls to our Smoke service. Smoke has direct disk access to the repositories and essentially presents Grit::Git as a service. It’s called Smoke because Smoke is just Grit in the cloud. Get it?</code></p>

<p><a href="https://github.com/blog/530-how-we-made-github-fast">https://github.com/blog/530-how-we-made-github-fast</a>
<a href="http://www.slideshare.net/rubymeetup/inside-github-with-chris-wanstrath">http://www.slideshare.net/rubymeetup/inside-github-with-chris-wanstrath</a></p>

<p>而 smoke 又用了 bertrpc</p>

<ul>
<li>bertrpc <a href="https://github.com/mojombo/bertrpc">https://github.com/mojombo/bertrpc</a></li>
</ul>


<p><code>For our data serialization and RPC protocol we are using BERT and BERT-RPC.</code></p>

<p>和</p>

<ul>
<li>proxymachine <a href="https://github.com/mojombo/proxymachine">https://github.com/mojombo/proxymachine</a></li>
</ul>


<p>保持連線平穩</p>

<p><code>ProxyMachine is my content aware (layer 7) TCP routing proxy that lets us write the routing logic in Ruby.</code></p>

<p><code>Each frontend runs four ProxyMachine instances behind HAProxy that act as routing proxies for Smoke calls.</code></p>

<p>再使用 chimney 控制 route</p>

<ul>
<li>chimney</li>
</ul>


<p><code>Chimney finds the route by making a call to Redis. Redis runs on the database servers. We use Redis as a persistent key/value store for the routing information and a variety of other data.</code></p>

<p>而每台 Fileserver 上面跑了兩組 Ernie Server。Erine 是 BERT-RPC server implementation that uses an Erlang server to accept incoming connections。</p>

<ul>
<li>ernine <a href="http://github.com/mojombo/ernie">http://github.com/mojombo/ernie</a></li>
</ul>


<p><code>Every file server runs two Ernie RPC servers behind HAProxy. Each Ernie spawns 15 Ruby workers. These workers take the RPC call and reconstitute and perform the Grit call. The response is sent back through the Smoke proxy to the Rails app where the Grit stub returns the expected Grit response.</code></p>

<p>當事情出錯了，用 Failbot 去掌握災情..</p>

<ul>
<li>failbot <a href="https://gist.github.com/1162437">https://gist.github.com/1162437</a></li>
</ul>


<p>===</p>

<ul>
<li>gerve</li>
</ul>


<p>用 Gerve 去管控 identity</p>

<p><code>GitHub user and this information is sent along with the original command and arguments to our proprietary script called Gerve (Git sERVE). Think of Gerve as a super smart version of git-shell.</code></p>

<p><code>Gerve verifies that your user has access to the repository specified in the arguments. If you are the owner of the repository, no database lookups need to be performed, otherwise several SQL queries are made to determine permissions</code></p>

<ul>
<li>resque <a href="https://github.com/defunkt/resque">https://github.com/defunkt/resque</a></li>
</ul>


<p>用 resque 實作 job queue</p>

<p><code>Resque (pronounced like "rescue") is a Redis-backed library for creating background jobs, placing those jobs on multiple queues, and processing them later.</code></p>

<ul>
<li>rock-queue <a href="https://github.com/grzegorzkazulak/rock-queue">https://github.com/grzegorzkazulak/rock-queue</a></li>
</ul>


<p>RockQueue 是用來把東西丟進 resque</p>

<p><code>Rock Queue is a simple, yet powerful unified interface for various messaging queues. In other words it allows you to swap your queuing back-end without making any modification to your application except changing the configuration parameters.</code></p>

<ul>
<li>jekyll <a href="https://github.com/mojombo/jekyll">https://github.com/mojombo/jekyll</a></li>
</ul>


<p>jekyll 用來生靜態檔案</p>

<p><code>Jekyll is a simple, blog aware, static site generator. It takes a template directory (representing the raw form of a website), runs it through Textile or Markdown and Liquid converters, and spits out a complete, static website suitable for serving with Apache or your favorite web server.</code></p>

<ul>
<li>nodeload <a href="https://github.com/blog/678-meet-nodeload-the-new-download-server">https://github.com/blog/678-meet-nodeload-the-new-download-server</a></li>
</ul>


<p>nodeload 是拿來 handling download files</p>

<ul>
<li>albino <a href="https://github.com/github/albino">https://github.com/github/albino</a></li>
</ul>


<p>albino 拿來處理 pygments 上色</p>

<p><code>Albino: a ruby wrapper for pygmentize</code></p>

<ul>
<li>markup <a href="https://github.com/github/markup">https://github.com/github/markup</a></li>
</ul>


<p>markup 用來處理不同 format 文檔的 rendering</p>

<p><code>We use this library on GitHub when rendering your README or any other rich text file.</code></p>

<ul>
<li>camo <a href="https://github.com/atmos/camo">https://github.com/atmos/camo</a></li>
</ul>


<p>camo 用來作 SSL proxy</p>

<p><code>Camo is all about making insecure assets look secure. This is an SSL image proxy to prevent mixed content warnings on secure pages served from GitHub.</code></p>

<ul>
<li>gollum <a href="https://github.com/github/gollum">https://github.com/github/gollum</a></li>
</ul>


<p>gollum 作 wiki-backend</p>

<p><code>Gollum wikis are simply Git repositories that adhere to a specific format. Gollum pages may be written in a variety of formats and can be edited in a number of ways depending on your needs. You can edit your wiki locally</code></p>

<ul>
<li>stratocaster <a href="https://github.com/technoweenie/allofthestars/tree/master/vendor/stratocaster">https://github.com/technoweenie/allofthestars/tree/master/vendor/stratocaster</a></li>
</ul>


<p>stratocaster 拿來作 event timeline</p>

<p><code>Stratocaster is a system for storing and retrieving messages on feeds. A message can contain any arbitrary payload. A feed is a filtered stream of messages. Complex querying is replaced in favor of creating multiple feeds as filters for the messages. Stratocaster uses abstract adapters to persist the data, instead of being bound to any one type of data store.</code></p>

<ul>
<li>amen</li>
</ul>


<p>amen is for graphing ( 我找不到資料 )</p>

<ul>
<li>heaven 用來作 deploy</li>
</ul>


<p><a href="http://bloggitation.appspot.com/entry/rubykaigi-2001-notes-day-1">http://bloggitation.appspot.com/entry/rubykaigi-2001-notes-day-1</a>
<a href="https://github.com/holman/feedback/issues/38">https://github.com/holman/feedback/issues/38</a></p>

<p>`Heaven - wrapper around capistrano for easy branch deployments:</p>

<p>heaven -a github -e production -h fe -b my_branch`</p>

<ul>
<li>haystack 拿來收集 Failbot 傳回來的 Exception log</li>
</ul>


<p><a href="http://www.slideshare.net/rubymeetup/inside-github-with-chris-wanstrath">http://www.slideshare.net/rubymeetup/inside-github-with-chris-wanstrath</a> # 173</p>

<p><code>We use in-house app called Haystack to monitor abitrary information treacked as JSON</code></p>

<ul>
<li>hubot</li>
</ul>


<p>就是…bot XD</p>

<p><a href="http://hubot.github.com/">http://hubot.github.com/</a></p>

<ul>
<li>github-services</li>
</ul>


<p><a href="https://github.com/github/github-services">https://github.com/github/github-services</a></p>

<p><code>Official GitHub Services Integration - You can set these up in your repo admin screen under Service Hooks</code></p>

<ul>
<li>help.github.com</li>
</ul>


<p><a href="https://github.com/github/help.github.com">https://github.com/github/help.github.com</a></p>

<p><code>opensource GitHub help guides</code></p>

<p>這一段只有七分鐘，但蒐集到的資料太多了…</p>

<p>開下一篇等等再接著寫。</p>

<h2>其他</h2>

<p>在翻一些相關資料時，還找到不少好東西</p>

<ul>
<li><a href="https://github.com/blog/530-how-we-made-github-fast">https://github.com/blog/530-how-we-made-github-fast</a></li>
<li><a href="http://www.slideshare.net/rubymeetup/inside-github-with-chris-wanstrath">http://www.slideshare.net/rubymeetup/inside-github-with-chris-wanstrath</a></li>
</ul>


<p>這兩篇也給了蠻多其他的 detail 的&#8230;</p>

  </div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/posts/2011/12/09/how-to-design-helpers-2/">如何運用 / 設計 Rails Helper (2)</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2011-12-09T16:36:00+08:00" pubdate  data-updated="true" >Dec 9<span>th</span>, 2011</time>
        
         | <a href="/posts/2011/12/09/how-to-design-helpers-2/#disqus_thread">Comments</a>
        

      </p>
    
  </header>


  <div class="entry-content">
    
      <div class="FacebookLikeButton"><div class="fb-like" data-href="http://blog.xdite.net/posts/2011/12/09/how-to-design-helpers-2/" data-show-faces="false"></div></div>
    
    <p>本系列第一篇：</p>

<p><a href="http://blog.xdite.net/posts/2011/12/08/how-to-design-helpers/">如何運用 / 設計 Rails Helper (1)</a></p>

<p>===</p>

<h2>為什麼在專案中我們要撰寫「自用」 Helper？</h2>

<h3>其一：在 View 裡面實作 LOGIC 是不好的。</h3>

<h4>造成效能低落</h4>

<p>在 <a href="http://blog.xdite.net/posts/2011/12/04/misunderstanding-about-render/">對於使用 Render Partial 的一些誤解</a> 一文中。我有解釋過在 View 裡面實作 LOGIC 的影響：「效能低落」。原因是 ERB 是用 eval 實作 執行 Ruby code 的。在 View 裡面穿插大量的 LOGIC 會造成 render 的效率低落。</p>

<h4>造成程式碼混亂難讀</h4>

<p>View 在 MVC 的模式中，原本就是只為了做 UI 輸出的功用的。如果有程式邏輯，或者是資料查詢，應該挪到 Controller 或 Model 去做。</p>

<p>這通常在 PHP 出身轉過來的 Programmer 身上，比較能找到這樣的問題。原因是在 PHP 寫作，這樣是很天經地義的作法。但眾所週知的，PHP 的 project 也特別容易藏汙納垢。</p>

<p>如果你拿到一個 Project，View 一打開來都 7-8 頁以上，別懷疑，肯定都是 LOGIC in View 造成的。而根據經驗，有長 View 問題的 project，往往比長 controller 的 project 還要難纏。</p>

<p>一個 view 若有著很多 if / else / elsif , query_some_data。又有著 if / else / elsif , change some css class ?</p>

<p><code>人的大腦不是 Ruby Interpreter，很難腦內想像這麼複雜的 code 會長什麼樣子，沒多久就會當機的....</code></p>

<h3>其二：讓 View 更加直觀好維護。</h3>

<p>看的懂這段 code 的意圖嗎？</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="err">&lt;</span>% if current_user <span class="err">&amp;&amp;</span> (post.user == current_user || current.user.is_forum_admin? || current.user_is_admin? ) %&gt;
</span><span class='line'>  <span class="err">&lt;</span>%= link_to(&quot;Edit&quot;, edit_post_path(post) ) %&gt;
</span><span class='line'>  <span class="err">&lt;</span>% end %&gt;
</span></code></pre></td></tr></table></div></figure>


<p>我想這段還算簡單，應該不難讓人猜到。</p>

<p>不過如果這一段 code 再經過兩三輪的維護，應該就會變得超難維護了。</p>

<p>正確的寫法其實應該要把邏輯拆出來，放在 Helper 裡。</p>

<p>就像這樣：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="err">&lt;</span>% if can_edit?(post) %&gt;
</span><span class='line'>     <span class="err">&lt;</span>%= link_to(&quot;Edit&quot;, edit_post_path(post) ) %&gt;
</span><span class='line'>  <span class="err">&lt;</span>% end %&gt;
</span></code></pre></td></tr></table></div></figure>


<p>後續維護者就知道，這一段程式碼就是在表示：<strong>如果當前使用者有權限編輯，就應該顯示編輯頁面的連結。</strong></p>

<h3>其三：給 Code 取名字，容易尋找並複用成果。</h3>

<p>上面那一段範例的程式碼寫得還不算好，因為它只表明了：<strong>如果當前使用者有權限編輯，就應該顯示編輯頁面的連結。</strong>。並沒達到正確闡述自己存在的的意義。</p>

<p>而這一塊原始碼的意圖是，若有編輯權限，這裡應該應顯示一塊 Toolbar。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="err">&lt;</span>%= render_tool_bar %&gt;
</span></code></pre></td></tr></table></div></figure>


<p>包裝成 Toolbar 後，這一塊程式碼就變得有名字了，下次你在某個頁面要寫到類似的功能時，就只要呼叫 render_tool_bar 就可以了。</p>

<p>而最重要的，是你以後再維護這一塊程式碼時，完全不必再猜測程式意圖，也很容易找當初亂丟在哪裡了。</p>

<h3>其四： 不會被以前寫的 Code 害死。</h3>

<p>下面所說的這種 code 在網站初期建設需要高速開發時沒有什麼不好。其實也還算讓人看得懂&#8230;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="err">&lt;</span>% if current_user <span class="err">&amp;&amp;</span> (post.user == current_user || current.user.is_forum_admin? || current.user_is_admin? ) %&gt;
</span><span class='line'>  <span class="err">&lt;</span>%= link_to(&quot;Edit&quot;, edit_post_path(post) ) %&gt;
</span><span class='line'>  <span class="err">&lt;</span>% end %&gt;
</span></code></pre></td></tr></table></div></figure>


<p>但我建議：一旦接近完工狀態就要儘快 refactor 掉它。</p>

<p>這種 code 一旦越來越多，網站就會越來越難維護。累積到一個程度，網站就會變成 unmaintainable&#8230;</p>

<p>像是我的 Team 或專案都有一個慣例，一旦專案開發快到尾聲，一定會開始整理 code，把重複的 code 包成有名字的 Helper。</p>

<p>這樣作有什麼好處？</p>

<ol>
<li><p>網站以後要進行結構重整時，只要調整已定義好的 Helper 內部架構就好了。如果還是東一個西一個到處亂放，同樣的東西重複貼 10 個地方，將來想要調整就要改 10 遍。相信我，你不喜歡在「改版時期」改 code 改 10 遍。就算 git grep 還是會改漏掉…</p></li>
<li><p>painless 升級 Rails 版本。有很多人好奇我手上的每個專案，為何可以一路從 2.3.x 一路升升升到3.1.x 去。卻還是輕鬆愉快？</p></li>
</ol>


<p>中間不是有令人抓狂的 html_escape API 行為改變問題？asset_pipeline 架構調整？這些都是很 painful 的過程。不少人都在升版過程中放棄了。為什麼我們還是寫意的辦到了。</p>

<p>關鍵不在於有沒有寫 test 的關係，而是在於「有沒有擁有定期整理 code 的習慣」。</p>

<p>不管是 helper / partial / controller / model ，只要是重複的 code ，定期都會進行封裝整理。就算有東西爆炸，也只要調整一下 helper 或者是 model 的輸出，就辦到了。</p>

<p>所以就算 Rails 要升版，精力也都是集中在處理幾個 deprecated method 或 incompatible API 的調整。就算 view 爆掉，也只要改一個地方，10 個地方都會生效。自然寫意無比。</p>

<h3>其五：容易複用並開創專案打下來的 best practices</h3>

<p>在進行專案過程中，也會漸漸的養出自己的一套 HTML 架構 與 CSS (SCSS)。很多元件在不同專案中都是共通的，比如說自己用來 bootstrap （非 twitter）專案的 view 和 helper。</p>

<p>navgation_bar, user_bar, breadcrumb, menu list, table, button,gravator 這些都是專案必備。</p>

<p>這是前東家 <a href="http://handlino.com">Handlino</a> 設計的一套 helper
<a href="https://github.com/handlino/handicraft_helper">https://github.com/handlino/handicraft_helper</a></p>

<p>可以很方便就寫出 menu, table, body class with browser type, breadcrumb…etc.</p>

<p>而我作網站還會多上幾套自己養出來的標準 Helper</p>

<ul>
<li>SEO 最佳化實踐</li>
<li>Social Media Share-Friendly</li>
<li>Content Site 常用功能最佳實踐</li>
</ul>


<p>專案越寫越多，後期越來越輕鬆，但不管之後再寫什麼新網站，依舊是幾乎都預設含有以前維護舊網站時打下的 Best Practices.</p>

<p>// 最近的目標換在整理 SCSS …</p>

<p>===</p>

<p>接下來幾章將會介紹：</p>

<p>什麼是不好的 Helper Pattern 應儘量避免、自用 Helper 的設計整理原則、如何將常用 Helper 抽取出來可以複用。</p>

  </div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/posts/2011/12/08/how-to-design-helpers/">如何運用 / 設計 Rails Helper (1)</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2011-12-08T21:40:00+08:00" pubdate  data-updated="true" >Dec 8<span>th</span>, 2011</time>
        
         | <a href="/posts/2011/12/08/how-to-design-helpers/#disqus_thread">Comments</a>
        

      </p>
    
  </header>


  <div class="entry-content">
    
      <div class="FacebookLikeButton"><div class="fb-like" data-href="http://blog.xdite.net/posts/2011/12/08/how-to-design-helpers/" data-show-faces="false"></div></div>
    
    <p>Helper 與 Partial 一直是初學者比較容易迷路的主題之一。迷路的原因有幾個：</p>

<ol>
<li>不知道有 Rails 提供了許多好用的 Helper 可以用</li>
<li>不知道 Helper 與 Partial 他們各自的使用時機。</li>
<li>擔心使用 Helper 會造成效能下降。</li>
<li>以不好的方式使用 Helper 反而使維護性降低。</li>
</ol>


<p>因此，一直以來這也是我比較想寫的一個主題…</p>

<h2>Helper 與 Partial</h2>

<h3>Partial</h3>

<p>Partial 指的是局部樣板。而 Helper 指的卻是在樣板中的一些幫助方法（Ruby Method）。這兩種都是整理又臭又長的 HTML 版面時的好工具。</p>

<p>一般而言，我們會使用 Partial 去處理大段且重複的程式碼。或者是經常使用到的局部程式碼。</p>

<ul>
<li>大段程式碼：（如 new / edit 會複用到的表單）</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%= form_for @post do |f| %&gt;</span>
</span><span class='line'><span class="sx">    &lt;%=</span> <span class="n">render</span> <span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="s2">&quot;form&quot;</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:f</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="p">}</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">&lt;% end %&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>經常使用到的局部程式碼：（如 sidebar 內的區塊）</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;sidebar&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="err">&lt;</span>%= render :partial =&gt; &quot;recent_posts&quot; %&gt;
</span><span class='line'>  <span class="err">&lt;</span>%= render :partial =&gt; &quot;recent_comments&quot; %&gt;
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>…etc.</p>

<h4>Partial 的優點</h4>

<ul>
<li>Don&#8217;t repeat yourself（DRY）程式碼不重複</li>
<li>程式修改會比較清楚</li>
<li>Partial 樣板比較容易被重複使用</li>
</ul>


<h3>Helper</h3>

<p>Partial 的定位多半是被用來處理「大片 HTML 」的工具，而 Helper 卻是比較屬於需要邏輯性輸出 HTML 時用的整理工具。</p>

<p>一般我們學 Rails 常見的</p>

<ul>
<li>stylsheet_link_tag</li>
<li>link_to</li>
<li>image_tag</li>
<li>form_for 中的 f.text_field…etc</li>
</ul>


<p>都屬於 Helper 的範疇。</p>

<h2>為什麼在專案中我們要使用內建 Helper 開發？</h2>

<h3>其一：為了省力</h3>

<p>Rails 最令其他 Ruby Web Framework 羨慕的，就是內建的很多方便 Helper。</p>

<p>舉幾個其實很方便，但大家其實不太知道它們存在的 Helper 好了。</p>

<ul>
<li><a href="http://apidock.com/rails/ActionView/Helpers/TextHelper/simple_format">simple_format</a> : 可以處理使用者的內容中 \r\n 自動轉 br 和 p 的工作</li>
<li><a href="http://apidock.com/rails/ActionView/Helpers/TextHelper/auto_link">auto_link</a> :可以處理使用者的內容中，若有連結，就自動 link 的工作。</li>
<li><a href="http://apidock.com/rails/ActionView/Helpers/TextHelper/truncate">truncate</a>: 使用者輸入的內容，若過長，可以指定多少字後就自動砍掉，並加入 &#8220;….&#8221;</li>
<li><a href="http://apidock.com/rails/ERB/Util/html_escape/class">html_escape</a>: 使用者輸入的內容，若有 html tag，為了怕使用者輸入惡意 tag 進行 hack。自動過濾。（以前要手動加 h 過濾，現在 Rails 預設 escape，不想被 escape 才手動指定 raw 閃掉 escape）</li>
</ul>


<p>這些東西若自己寫 parser 處理，不知道要花費多少精力，還不一定濾的徹底。卻都是 Rails 預設內建 Helper。</p>

<h3>其二：為了跟 Rails 內建的其他更棒的基礎建設整合</h3>

<ul>
<li>stylesheet_link_tag 與 image_tag</li>
</ul>


<p>有些人也覺得，這東西還要用 Helper 嗎？直接貼 HTML 不是也一樣會動嗎？有什麼差別。差別可大了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="o">&lt;</span><span class="sx">%= stylesheet_link_tag &quot;abc&quot;, &quot;def&quot;, :cache =</span><span class="o">&gt;</span> <span class="kp">true</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>這一行，可以在 production 環境時，自動幫你將兩支 CSS 自動壓縮成一支 all.css 。直接實現了 Yahoo <a href="http://developer.yahoo.com/performance/rules.html">Best Practices for Speeding Up Your Web Site</a>中，minify HTTP reqesut 的建議。而在 Rails 3.1 之後，甚至還會自動幫你 trim 與 gzip。</p>

<p>完全不需要去在 deploy process 中 hook 另外的 compressor 就可以達到。</p>

<p>至於 image_tag 有什麼特別的地方？</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="o">&lt;%=</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">&quot;xxx.jpg&quot;</span><span class="p">)</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Rails 可以幫你的 asset 自動在後面上 query string，如：xxx.jpg?12345</p>

<p>這樣在網站若有整合 CDN 架構時，可以自動處理 invalid cache 的問題。</p>

<p>而 Rails 也有選項可以實作 asset parallel download 的機制，一旦打開，站上的 asset 也會配合你的設定，亂數吐不同來源的 asset host 實做平行下載。</p>

<p>輕鬆就可以把網站 Scale 上去。</p>

<ul>
<li>form_for</li>
</ul>


<p>這也是 Rails 相當為人稱讚的一個利器。Rails 的表單欄位是綁 model (db 欄位的)，除了開發方便（ <code>Post.new(params[:post])</code> 直接收參數做 mapping）之外，也內建了防 CSRF (<code>protect_from_forgery</code>)的防禦措施。</p>

<p>===</p>

<p>可以在一眨眼的工夫，實作出業界（performace /security）最佳實踐。而你卻不需要是架構大師。</p>

  </div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/posts/2011/12/05/omniauth-clean-auth-provider-4/">OmniAuth - 實作多方認證的最佳實踐 (4)</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2011-12-05T21:40:00+08:00" pubdate  data-updated="true" >Dec 5<span>th</span>, 2011</time>
        
         | <a href="/posts/2011/12/05/omniauth-clean-auth-provider-4/#disqus_thread">Comments</a>
        

      </p>
    
  </header>


  <div class="entry-content">
    
      <div class="FacebookLikeButton"><div class="fb-like" data-href="http://blog.xdite.net/posts/2011/12/05/omniauth-clean-auth-provider-4/" data-show-faces="false"></div></div>
    
    <p>兩週前談到 OmniAuth，還剩下最後一篇欠稿：實作篇。來還債了&#8230;</p>

<ul>
<li><a href="http://blog.xdite.net/posts/2011/11/19/omniauth-clean-auth-provider-1/">OmniAuth - 實作多方認證的最佳實踐 (1)</a></li>
<li><a href="http://blog.xdite.net/posts/2011/11/19/omniauth-clean-auth-provider-2/">OmniAuth - 實作多方認證的最佳實踐 (2)</a></li>
<li><a href="http://blog.xdite.net/posts/2011/11/19/omniauth-clean-auth-provider-3/">OmniAuth - 實作多方認證的最佳實踐 (3)</a></li>
</ul>


<p>本來還在煩惱怎樣給出一個 demo app。剛好最近幫忙翻修 <a href="http://ruby-taiwan.org">http://ruby-taiwan.org</a>。網站的 0.3 => 1.0 的升級就是出於筆者之手。</p>

<p>乾脆拿這個網站直接來講&#8230;</p>

<p>若最後還是看不懂示範的可以直接 <a href="git://github.com/rubytaiwan/ruby-taiwan.git">clone 專案</a>下來直接 copy。</p>

<h2>Install Devise</h2>

<ol>
<li>安裝 Devise</li>
<li><code>rails g devise User</code> 產生 User model</li>
<li><code>rails g model Authorization provider:string user_id:integer uid:string</code> 產生 Authorization Model</li>
</ol>


<p>User <strong>has_many</strong> Authorizations</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:authorizations</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Authorization</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:user</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Install OmniAuth</h2>

<ul>
<li>安裝 OmniAuth 1.0</li>
<li>安裝 omniauth-github 與 omniauth-twitter</li>
</ul>


<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">gem</span> <span class="s1">&#39;devise&#39;</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s1">&#39;https://github.com/plataformatec/devise.git&#39;</span>
</span><span class='line'> <span class="n">gem</span> <span class="s2">&quot;omniauth&quot;</span>
</span><span class='line'> <span class="n">gem</span> <span class="s2">&quot;omniauth-github&quot;</span>
</span><span class='line'> <span class="n">gem</span> <span class="s2">&quot;omniauth-twitter&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>定義 :omniauthable</li>
</ul>


<p>在 User model 內加入 <code>:omniauthable</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span><span class="p">,</span> <span class="ss">:omniauthable</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>extend OmniauthCallbacks</li>
</ul>


<p>在 <code>User</code> model extend OmniauthCallbacks</p>

<figure class='code'><figcaption><span>app/model/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">OmniauthCallbacks</span>
</span></code></pre></td></tr></table></div></figure>


<p>`</p>

<ul>
<li>新增 <code>app/model/users/omniauth_callbacks.rb</code></li>
</ul>


<p>具體內容請看這裡 <a href="https://github.com/rubytaiwan/ruby-taiwan/blob/master/app/models/user/omniauth_callbacks.rb">https://github.com/rubytaiwan/ruby-taiwan/blob/master/app/models/user/omniauth_callbacks.rb</a></p>

<p>主要是拿 callbacks 回來的東西 new_from_provider_data 塞進去。先找有沒有，有找到回傳 user。沒找到從 data 裡塞資料進去，同時建立 provider 與 uid 關係。</p>

<h2>設定 route 與 controller</h2>

<p><code>config/routes.rb</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">devise_for</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:controllers</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:registrations</span> <span class="o">=&gt;</span> <span class="s2">&quot;registrations&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:omniauth_callbacks</span> <span class="o">=&gt;</span> <span class="s2">&quot;users/omniauth_callbacks&quot;</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">get</span> <span class="s2">&quot;logout&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;devise/sessions#destroy&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>app/controllers/users/omniauth_callbacks_controller.rb</code></p>

<p>具體內容看這裡 <a href="https://github.com/rubytaiwan/ruby-taiwan/blob/master/app/controllers/users/omniauth_callbacks_controller.rb">https://github.com/rubytaiwan/ruby-taiwan/blob/master/app/controllers/users/omniauth_callbacks_controller.rb</a></p>

<p>光用  <code>app/model/users/omniauth_callbacks.rb</code> 與 <code>app/controllers/users/omniauth_callbacks_controller.rb</code> 這兩招就可以把 callback 和 provider 切得很漂亮了。</p>

<h2>申請 OAuth</h2>

<p>各大網站都有審請 OAuth 的機制：</p>

<ul>
<li>Twitter: <a href="https://dev.twitter.com/apps/new">https://dev.twitter.com/apps/new</a></li>
<li>Github: <a href="https://github.com/account/applications">https://github.com/account/applications</a></li>
</ul>


<p>如果你是使用 ruby-taiwan 這個 project 的話</p>

<ul>
<li>網址填 http://ruby-taiwan.dev/</li>
<li>Call 網址填 http://ruby-taiwan.dev/account/auth/github/callback</li>
</ul>


<p><strong> 一定得這樣填，亂改炸掉別怪我.. </strong></p>

<h2>設定 token</h2>

<p>key 設定都放在這裡 <code>config/initializers/devise.rb</code></p>

<p><a href="https://github.com/rubytaiwan/ruby-taiwan/blob/master/config/initializers/devise.rb">https://github.com/rubytaiwan/ruby-taiwan/blob/master/config/initializers/devise.rb</a></p>

<figure class='code'><figcaption><span>config/initializers/devise.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">omniauth</span> <span class="ss">:github</span><span class="p">,</span> <span class="no">Setting</span><span class="o">.</span><span class="n">github_token</span><span class="p">,</span> <span class="no">Setting</span><span class="o">.</span><span class="n">github_secret</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">omniauth</span> <span class="ss">:twitter</span><span class="p">,</span> <span class="no">Setting</span><span class="o">.</span><span class="n">twitter_token</span><span class="p">,</span> <span class="no">Setting</span><span class="o">.</span><span class="n">twitter_secret</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">omniauth</span> <span class="ss">:douban</span><span class="p">,</span> <span class="no">Setting</span><span class="o">.</span><span class="n">douban_token</span><span class="p">,</span> <span class="no">Setting</span><span class="o">.</span><span class="n">douban_secret</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">omniauth</span> <span class="ss">:open_id</span><span class="p">,</span> <span class="ss">:store</span> <span class="o">=&gt;</span> <span class="no">OpenID</span><span class="o">::</span><span class="no">Store</span><span class="o">::</span><span class="no">Filesystem</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;/tmp&#39;</span><span class="p">),</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;google&#39;</span><span class="p">,</span> <span class="ss">:identifier</span> <span class="o">=&gt;</span> <span class="s1">&#39;https://www.google.com/accounts/o8/id&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="s1">&#39;omniauth-openid&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Link Helper</h2>

<p>可看 <a href="https://github.com/rubytaiwan/ruby-taiwan/blob/master/app/views/devise/sessions/new.html.erb">https://github.com/rubytaiwan/ruby-taiwan/blob/master/app/views/devise/sessions/new.html.erb</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>          <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= link_to &quot;Twitter&quot;, user_omniauth_authorize_path(:twitter) %&gt; <span class="nt">&lt;/li&gt;</span>
</span><span class='line'>          <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= link_to &quot;Google&quot;, user_omniauth_authorize_path(:google) %&gt; <span class="nt">&lt;/li&gt;</span>
</span><span class='line'>          <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= link_to &quot;Github&quot;, user_omniauth_authorize_path(:github) %&gt; <span class="nt">&lt;/li&gt;</span>
</span><span class='line'>          <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= link_to &quot;Douban&quot;, user_omniauth_authorize_path(:douban) %&gt; <span class="nt">&lt;/li&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>小結</h2>

<p>這樣就設完了，非常乾淨。如果有任何問題歡迎上 <a href="http://ruby-taiwan.org">http://ruby-taiwan.org</a> 討論。</p>

  </div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/posts/2011/12/04/misunderstanding-about-render/">對於使用 Render Partial 的一些誤解</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2011-12-04T11:30:00+08:00" pubdate  data-updated="true" >Dec 4<span>th</span>, 2011</time>
        
         | <a href="/posts/2011/12/04/misunderstanding-about-render/#disqus_thread">Comments</a>
        

      </p>
    
  </header>


  <div class="entry-content">
    
      <div class="FacebookLikeButton"><div class="fb-like" data-href="http://blog.xdite.net/posts/2011/12/04/misunderstanding-about-render/" data-show-faces="false"></div></div>
    
    <p><a href="http://ruby-taiwan.org">http://ruby-taiwan.org</a> 是從 <a href="https://github.com/huacnlee/ruby-china">ruby-china</a> 這個專案 fork 出來改的。</p>

<p>====</p>

<p>本文章經過 <a href="https://github.com/huacnlee/ruby-china">ruby-china</a> 作者 <a href="http://twitter.com/huacnlee">huacnlee</a> 同意後進行寫作。</p>

<p>===</p>

<p>坦白說，最初會開始把玩這個專案，是因為覺得想法和介面上做的不錯，想 clone 下來玩玩看。不過這個 project 當時的狀態可以說是「unmaintainable」。</p>

<p>造成 unmaintainable 的因素主要有兩個：</p>

<ul>
<li>使用不好的寫法 implement 連結。</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;&lt;%= posts_path %&gt;&quot;</span><span class="o">&gt;</span> <span class="no">ALL</span> <span class="no">POST</span> <span class="o">&lt;</span><span class="sr">/a&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>view 裡面充滿 LOGIC。</li>
</ul>


<p>這是當時的 <a href="https://github.com/huacnlee/ruby-china/blob/1e3359a26dd71ece872c5f4adfcabc054f5b9c83/app/views/topics/index.html.erb">app/views/topics/index.html.erb</a> 和 <a href="https://github.com/huacnlee/ruby-china/blob/1e3359a26dd71ece872c5f4adfcabc054f5b9c83/app/views/topics/_sidebar.html.erb">app/views/topics/_sidebar.html.erb</a></p>

<p>在我 join 這個專案之後，第一件事就是清 code，把 project 翻修到大家都改的動&#8230;.</p>

<h2>對於 render :partial 的誤解</h2>

<p>會產生這樣的 code，是有原因的。主要是因為作者</p>

<ul>
<li>想要複用 index 與 sidebar</li>
<li>不想使用人人都「覺得」慢的 render :partial，所以才用 LOGIC 判斷，要吐哪一些內容出來。</li>
</ul>


<p>而「被覺得慢的 partial」，也是促使我想寫這篇文章的主要原因。</p>

<h3>聰明反被聰明誤</h3>

<p>造成這個 project unmaintainable 的兩大主要原因，背後的想法是</p>

<ol>
<li>「覺得」使用 Ruby 去產生 link 會產生 extra function call，拖累效能。所以乾脆只取用 path_helper</li>
<li>「覺得」使用 partial 會變慢，所以刻意使用 LOGIC in View 去控制顯示的內容。</li>
</ol>


<p>而第一點造成了 連結 unmaintainable，第二點造成 View 不僅 unmaintainable，還 ULTRA SLOW。</p>

<p>而這也不怪作者，幾乎我認識的一些 Rails Developer，都帶著這樣的偏見。</p>

<p>(我自己以前對 partial 也是能閃就閃，只是我還是為了 code 乾淨度維護問題，繼續使用，然後再對緩慢的 partial 上 cache。)</p>

<h3>Partial 真正緩慢的原因 ：eval</h3>

<p>Partial 真正緩慢的原因是這樣：ERB 裡面能夠「跑」 code 的原因，是因為用 eval 去執行裡面 code 的內容。而一旦牽扯到「eval」，view 巨慢無比就是很正常的事。</p>

<p>你可以動手作個小實驗，render 一個 partial。裡面分別放入這樣的內容：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">12345</span> <span class="no">Hello</span> <span class="no">World</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="vi">@post</span><span class="o">.</span><span class="n">id</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% Post.first </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>也在這個 case 裡，如果直接拆成 partial，分塊呼叫的話，其實效率是非常高的，而且在維護上也非常直觀。而<code>原本為了避免採用 partial 造成效率低落所作的 LOGIC in View，反而是把這一頁效能完全拖垮的最大兇手</code>。</p>

<h3>Follow MVC : Never LOGIC in View</h3>

<p>不只是別在 Partial 裡面寫 LOGIC，更進一步的，其實你也應該儘量避免在 View 裡面寫任何 LOGIC。</p>

<p>follow MVC 在 Rails 的意義，不僅是因為遵循 MVC pattern 精神而已。更重要的是，<code>在 view 中 LOGIC 會直接帶來嚴重的效能低落</code>。</p>

<h3>How to organize code?</h3>

<p>接下來衍生出來一個常常被問到的問題：「如何區別使用 Helper 與 Partial 的時機？」</p>

<h4>Helper</h4>

<p>我建議的判斷準則是這樣的。如果只有三行 HTML 以內的 View，而這一段 code 常常會被使用到。應該將他翻修成 Helper。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">&quot;title&quot;</span><span class="nt">&gt;</span> <span class="nt">&lt;a</span> <span class="na">hre=</span><span class="s">&quot;/posts/1&quot;</span><span class="nt">&gt;</span> POST TITLE <span class="nt">&lt;/a&gt;</span> <span class="nt">&lt;/h1&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>翻修成</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">render_post_title</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
</span><span class='line'>  <span class="n">content_tag</span><span class="p">(</span><span class="ss">:h1</span><span class="p">,</span> <span class="n">link_to</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">post_path</span><span class="p">(</span><span class="n">post</span><span class="p">)),</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;title&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;%=</span> <span class="n">render_post_title</span><span class="p">(</span><span class="n">post</span><span class="p">)</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>或者是這樣的情形</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rhtml'><span class='line'>  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span> <span class="o">||</span> <span class="n">current</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_forum_admin?</span> <span class="o">||</span> <span class="n">current</span><span class="o">.</span><span class="n">user_is_admin?</span> <span class="p">)</span> <span class="cp">%&gt;</span>
</span><span class='line'>  <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">&quot;Edit&quot;</span><span class="p">,</span> <span class="n">edit_post_path</span><span class="p">(</span><span class="n">post</span><span class="p">)</span> <span class="p">)</span> <span class="cp">%&gt;</span>
</span><span class='line'>  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>翻修成</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rhtml'><span class='line'>  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">editable?</span><span class="p">(</span><span class="n">post</span><span class="p">)</span> <span class="cp">%&gt;</span>
</span><span class='line'>     <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">&quot;Edit&quot;</span><span class="p">,</span> <span class="n">edit_post_path</span><span class="p">(</span><span class="n">post</span><span class="p">)</span> <span class="p">)</span> <span class="cp">%&gt;</span>
</span><span class='line'>  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p> html</p>

<h4>Partial</h4>

<p>而使用 Partial 適當的時機是「大塊的 HTML 需要被複用」，所謂的大塊，是指 3 行以上的 HTML。千萬不要逞強使用 Helper 硬幹。用 Helper 包裹複雜的 HTML DOM 也會讓程式碼變得無法維護。</p>

<p>以前就曾經改到一段 code：Developer 根本不知道有 partial 可用，只知道有 helper。他覺得 helper 很棒，因此就拿來包一段 20 多行的 HTML。</p>

<p>結果美術的版不是 final，DOM 要大改重調位置，結果現場包含他自己，根本沒人看得懂 / 改的動這一段 code。</p>

<p>我自己個人蠻常使用的技巧則是<code>helper 與 partial</code>混用，比如說</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="err">&lt;</span>% if editable?(post) %&gt;
</span><span class='line'>     <span class="err">&lt;</span>%= render :tool_bar %&gt;
</span><span class='line'>  <span class="err">&lt;</span>% end %&gt;
</span></code></pre></td></tr></table></div></figure>


<h3>被迫得在 View 中 LOGIC 或 Query 怎麼辦？</h3>

<p>但有的時候，我們還是會被迫在 View 中寫程式，比如說跑迴圈 query…</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="err">&lt;</span>% sites.each do |site| %&gt;
</span><span class='line'>    <span class="err">&lt;</span>% site.categories.each do |category| %&gt;
</span><span class='line'>      <span class="err">&lt;</span>% category.popular_posts.each do |post| %&gt;
</span><span class='line'>         <span class="err">&lt;</span>%= post.title %&gt;
</span><span class='line'>         <span class="err">&lt;</span>%= post.content %&gt;
</span><span class='line'>      <span class="err">&lt;</span>% end %&gt;
</span><span class='line'>    <span class="err">&lt;</span>% end %&gt;
</span><span class='line'>  <span class="err">&lt;</span>% end %&gt;
</span></code></pre></td></tr></table></div></figure>


<p>常見的想法是，整片 <code>打 cache</code>。</p>

<p>但打 cache 其實沒有真正解決問題，當 cache expire 時，還是要有一個倒楣鬼，去負責 heat cache。就看哪個 user 倒楣囉。</p>

<p>這時候我會推薦你使用一套 gem : <a href="http://cells.rubyforge.org/">Cells - Components For Rails</a>。去取代 partial 的架構。</p>

<p>Cells 的架構，有些不一樣。它提出的概念是 <code>mini-controller</code> &amp; <code>partial</code>。也就是如果在 View 中 query 是昂貴的，你可以使用 Cells 提供的 mini-controller 把 query 拆上去。多層也沒問題，因為可以一直 render_cell 上去。</p>

<p>而 Cells 也是 cachable 的架構。</p>

<h2>Don&#8217;t use MVP &amp; Drapper</h2>

<p>近年比較熱的包裝手法是 MVP 和 Drapper，很不巧的都剛好是同一個作者 Jeff Casimir。</p>

<p>Rails 的 MVP 是他在 <a href="http://blip.tv/rubynation/jeff-casimir-fat-models-aren-t-enough-5562605">Fat Models Aren&#8217;t Euough</a> 倡導的。</p>

<p>MVP 其實並沒有解決 View 的問題，而更糟的是，把片段的邏輯拆出去變成一層 Presentor，讓 code 變得其實更難維護了。</p>

<p>而 <a href="http://railscasts.com/episodes/286-draper">Drapper</a> 更糟，玩的是 Decorater 手法。本來 Controller 與 View 混在一起就已經很糟了。而 Drapper 實作的手法，反而把整件事情帶往又更糟的方向…<code>Model 與 View 混在一起</code>。</p>

<p>更別提它的效能問題了…</p>

<p>-_-|||</p>

<p>難道只有我覺得他是害人精嗎？</p>

<h2>Conculsion</h2>

<p>怎麼寫出好的 Code? 其實一般人對於我的感覺是：看我談這麼多 Rails 寫作技巧，我一定對同事很要求。</p>

<p>很多人都有一個很大誤解：好的 Code 等於寫法漂亮的 Code，效能很高的 Code。所以一開始就給自己很大的壓力，第一次就要寫到漂亮，第一次就要寫到效能很棒，第一次就要用上很多技巧。</p>

<p>這是錯誤的想法。其實寫 Code 只有兩件事需要注意：</p>

<ol>
<li>別寫蠢 Code。有一些禁忌是絕對不能犯的。比如說

<ul>
<li>SLOW SQL (QUERY|REQUEST) in View。</li>
<li>wrap everything, 20 行的 HTML Helper</li>
</ul>
</li>
<li>寫出乾淨易懂的 code。

<ul>
<li>笨拙但直觀的 code 別人多半是可以勉強接受的。</li>
<li>直觀好維護的 code 才可以讓人看出你的意圖，從而改善。</li>
<li>一段好 code 也通常是經過這樣幾次的 refactor，才到達最後的水準…</li>
</ul>
</li>
</ol>


<p>我也只有執行這兩個原則而已。</p>

<p>一般實作功能，真正的效能瓶解往往不在於那多出來的幾個 function call。多半會在於你意想不到的地方，或者反而是你以為 optimize (效能/寫法)的地方。</p>

<p>好好運用內建的機制，不要嘗試用 Cache 硬隱藏原有的問題，其實這樣就夠了…</p>

  </div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/posts/2011/12/04/gollum-git-based-wiki/">Gollum : Git-backend Wiki</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2011-12-04T01:02:00+08:00" pubdate  data-updated="true" >Dec 4<span>th</span>, 2011</time>
        
         | <a href="/posts/2011/12/04/gollum-git-based-wiki/#disqus_thread">Comments</a>
        

      </p>
    
  </header>


  <div class="entry-content">
    
      <div class="FacebookLikeButton"><div class="fb-like" data-href="http://blog.xdite.net/posts/2011/12/04/gollum-git-based-wiki/" data-show-faces="false"></div></div>
    
    <p>這週繼續在實作 <a href="http://ruby-taiwan.org">http://ruby-taiwan.org</a> 上的 features。</p>

<p>既然要打造一個讓程式設計師很願意發表的社區，介面就要對 developer content 非常 friendly。</p>

<p>如何友善法？除了發文介面要做的棒，讓人很容易發表文章、寫回應之外，還要容易貼 code！社區不能貼 code 還叫程式社區嗎？</p>

<h2>Topic 與 Reply 支援多種語法、程式碼高亮</h2>

<p>所以這週的主要進度是：Topic 支援程式高亮了。(by <a href="http://twitter.com/yorkxin">@yorkxin</a> )，詳細的內容在這篇公告：<a href="http://ruby-taiwan.org/topics/31">新增多種語法支援：粗體、斜體、底線、程式碼高亮</a>。</p>

<h2>Wiki</h2>

<p>Wiki 是當初第二個看不順眼的東西。</p>

<p>在程式社區中 Wiki 也算是很重要的角色，但是一個爛的介面和動線也會讓人不怎麼想要貢獻內容。</p>

<p>而 <a href="http://ruby-taiwan.org">http://ruby-taiwan.org</a> 的 Wiki 其實還是只具備非常初階的功能，底層是用 DB 實作，而表單也是簡單的用 Bootstrap 套，雖然支援 Markdown 語法，但 Wiki 內連結什麼都還是要自己 hard link。貼程式碼也容易貼的歪七扭八…</p>

<p>理想的程式社區 Wiki 我覺得要具備幾個要素</p>

<ol>
<li>內容可以實現 [[ XXX ]] 站內超連結</li>
<li>Markdown 或 Markdown extra 以上功能</li>
<li>貼任何程式碼都支援高亮</li>
<li>Version Control ( 基本 )</li>
<li>可 Diff</li>
<li>權限控管</li>
<li>容易「預覽」的介面…</li>
</ol>


<p>不過這些願望就算是自己用 Rails 實作，也很苦手。因為有一大堆底層苦工需要先作…</p>

<p>我是個很討厭重造輪子的人，馬上就想起以前曾經用過的一套 Wiki : <a href="https://github.com/github/gollum">gollum</a>。</p>

<p>以前曾經寫過一篇文章介紹過這套 wiki : <a href="http://wp.xdite.net/?p=2182">用 Pow 架起 Gollum</a>。</p>

<p>Github 官方部落格上面的介紹：<a href="https://github.com/blog/699-making-github-more-open-git-backed-wikis">Making GitHub More Open: Git-backed Wikis</a></p>

<h3>gollum 的基本想法</h3>

<p>gollum 的想法是將 Wiki 的每一頁都視為一個檔案，塞進 Git 版本控制。這與傳統的 Wiki 作法不同，多數的 Wiki 實作是將每一頁視為一筆 DB record，而且還要另外拉一個表紀錄版本變遷（有的 Wiki 甚至沒有這樣功能）。</p>

<p>而用 Git 實作的好處，是檔案儲存、變更、版本控制、搜尋，就可以走 Git 本身的機制，不必再重造一套輪子了。所以當初看到 gollum 釋出的時候，受到很大的震撼，沒想過原來可以這樣惡搞閃掉重造輪子。</p>

<h3>gollum 的基本功能</h3>

<p>gollum 提供了一套 API，可以存取，版本控制，搜尋，自動將特定格式內容轉換。（支援 Markdown、RST, ASCIIDoc…等等）</p>

<p>而且 gollum 還提供一套用 Sinatra 刻的介面，可以讓人輕鬆的寫 Wiki…</p>

<h3>還是要重造輪子</h3>

<p>寫到這裡，可能會讓人以為我的作法可能是會將 gollum 當作一個 rack app 掛在 <a href="http://ruby-taiwan.org">http://ruby-taiwan.org</a> 就收工?</p>

<p>gollum 的介面頂多是勉強堪「自用」，所以在我自己的 Mac 上，我的確是用 gollum + Pow 架起來寫私人程式筆記的。但是 gollum 的 wiki 介面，我自己覺得連易用都摸不上邊&#8230;（更別提 1.3.x , web preview 介面是爛的 …）</p>

<p>再來是 gollum 並沒有權限與使用者概念，如果是用 web interface 發表，走的都是 local git config 的 user name…</p>

<h2>終極 solution</h2>

<p>以前自己寫過一個小專案，用 Rails 刻一套介面去接整套 gollum API，自己把 UI 改的 friedly 些。讓寫筆記的速度可以加快，直到 <a href="http://mouapp.com/">Mou</a> 出來之前，我一直都是這樣寫東西的…</p>

<p>要達到剛剛所說的六個重點，於是最後實作的解法就是…</p>

<h2>寫 Rails 去接 Gollum API…</h2>

<h3>Model</h3>

<p><a href="https://github.com/rubytaiwan/ruby-taiwan/blob/production/app/models/wiki.rb">https://github.com/rubytaiwan/ruby-taiwan/blob/production/app/models/wiki.rb</a></p>

<ul>
<li>檔案存取 / 版本控制：把整個 db 抽換掉，換成 gollum</li>
<li>與 bootstrap form 結合：因為 <a href="http://ruby-taiwan.org">http://ruby-taiwan.org</a> 是用 simple_form 實作表單，所以 Wiki 的部分是寫了一個 class 去 include ActiveModel 的一些 API 去接上 form</li>
</ul>


<h3>Controller</h3>

<p><a href="https://github.com/rubytaiwan/ruby-taiwan/blob/production/app/controllers/gikis_controller.rb">https://github.com/rubytaiwan/ruby-taiwan/blob/production/app/controllers/gikis_controller.rb</a></p>

<ul>
<li>CRU 接了 gollum API 去實作。</li>
<li>寫入 commit log 則取站上認證的 current_user 去塞</li>
</ul>


<h3>權限控制</h3>

<p><a href="https://github.com/rubytaiwan/ruby-taiwan/blob/production/app/models/ability.rb">https://github.com/rubytaiwan/ruby-taiwan/blob/production/app/models/ability.rb</a></p>

<ul>
<li>用 <a href="https://github.com/ryanb/cancan">CanCan</a> 去管基本的存取。若以後要上黑名單，細緻權限，鎖定，都可以從 CanCan 這端寫 rule block 掉。</li>
</ul>


<h3>Markdown Support &amp; Syntax Highlight</h3>

<p><a href="https://github.com/github/gollum/blob/master/lib/gollum/markup.rb">https://github.com/github/gollum/blob/master/lib/gollum/markup.rb</a></p>

<ul>
<li>gollum 本身就是使用 <a href="https://github.com/tanoku/redcarpet">Redcarpet</a> 去實作 Markdown 的 renderer，所以吐回來的 formatted_data 已經會是支援 Markdown Extra 以上的格式了。更棒的是也自動結合了<a href="http://rubygems.org/gems/pygments.rb">pygments.rb</a>。</li>
</ul>


<h3>Preview</h3>

<p><a href="https://github.com/github/gollum/blob/master/lib/gollum/wiki.rb">https://github.com/github/gollum/blob/master/lib/gollum/wiki.rb</a>
<a href="https://github.com/rubytaiwan/ruby-taiwan/blob/master/app/assets/javascripts/topics.coffee">https://github.com/rubytaiwan/ruby-taiwan/blob/master/app/assets/javascripts/topics.coffee</a></p>

<ul>
<li>本來在煩惱 Page Preview 要怎麼實作…真不想自己寫 renderer 硬幹。後來發現 gollum 也提供了 preview_page，提供 in-memory preview。而 <a href="http://twitter.com/yorkxin">@yorkxin</a> 這兩天才為 Topic &amp; Reply 寫一個 ajax preview。就用同樣的一套 interface 也接上去…</li>
</ul>


<h3>Backup</h3>

<ul>
<li>用 Git 實作 Wiki 最大的好處，是可以把內容都塞進一個資料夾內。再定期跑 crobtab 丟上 github …（這是其他 wiki 很難做到的地方）</li>
</ul>


<h2>踩到的一些雷</h2>

<p>其實事情也不是大家想像中的順利。主要還有遇到兩個地雷。</p>

<p><a href="https://github.com/xdite/gollum/commit/7924e8c9a90a772d90da5f7c6a3366bfc5010fbb">https://github.com/xdite/gollum/commit/7924e8c9a90a772d90da5f7c6a3366bfc5010fbb</a></p>

<ul>
<li>Redcarpet 的介面改變。原先 Redcarpet 1.0.x 是走 <code>Redcarpet.new(data, *flags).to_html</code> 這種介面。而 Redcarpet 2.0.x 是走 <code>markdown = Redcarpet::Markdown.new(html_renderer)</code>、<code>data = markdown.render(data)</code>。gollum 沒有鎖 redcarpet 版本，然後就大爆炸了。目前官方沒有 release 新 gem 的打算，只好自己 hot fix 然後拉 pull request 回去。</li>
</ul>


<p><a href="https://github.com/mojombo/grit/commit/696761d">https://github.com/mojombo/grit/commit/696761d</a></p>

<ul>
<li>Ruby 1.9.2 在塞中文內容進檔案時會爆炸。主要是 <a href="https://github.com/mojombo/grit">Git</a> 這套拿來存取 Git 的 Ruby Library，會遇上 UTF8 string 長度問題。同樣的，官方目前沒有 release 新 gem 的打算，不過 patch 已經進 master ..</li>
</ul>


<h2>小結</h2>

<p>所以為了作這個 Wiki 功能，用了..</p>

<ul>
<li>ActiveModel</li>
<li><a href="https://github.com/plataformatec/simple_form">simple_form</a></li>
<li><a href="https://github.com/ryanb/cancan">CanCan</a></li>
<li><a href="https://github.com/rafaelfranca/simple_form-bootstrap/blob/master/config/initializers/simple_form.rb">bootstrap + simple_form wrapper</a></li>
<li><a href="https://github.com/tanoku/redcarpet">RedCarpet</a></li>
<li><a href="http://rubygems.org/gems/pygments.rb">pygments.rb</a></li>
<li><a href="https://github.com/thetron/css3buttons_rails_helpers">css3buttons_rails_helpers</a></li>
<li><a href="http://jashkenas.github.com/coffee-script/">CoffeeScript</a></li>
</ul>


<p>非常神經病的列表…</p>

<p>不過出來的架構和最後呈現算是令人滿意&#8230;:D</p>

<p>歡迎用看看吧 <a href="http://ruby-taiwan.org/wiki">http://ruby-taiwan.org/wiki</a></p>

  </div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/posts/2011/11/28/ruby-taiwan-org/">http://ruby-taiwan.org 開張</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2011-11-28T01:46:00+08:00" pubdate  data-updated="true" >Nov 28<span>th</span>, 2011</time>
        
         | <a href="/posts/2011/11/28/ruby-taiwan-org/#disqus_thread">Comments</a>
        

      </p>
    
  </header>


  <div class="entry-content">
    
      <div class="FacebookLikeButton"><div class="fb-like" data-href="http://blog.xdite.net/posts/2011/11/28/ruby-taiwan-org/" data-show-faces="false"></div></div>
    
    <p>上禮拜看到對岸弄了一個 <a href="http://ruby-china.org">http://ruby-china.org</a>，看樣子蠻好玩的，介面也設計的不錯。而且這個網站還是 opensource 的，就抓下來玩了一下。</p>

<p>不過大概是程式碼加的太快，當時的程式碼不是很「乾淨」，抓下來一般人是改不太動的，加上沒有 test。所以我想一般人也沒人敢「翻修」。</p>

<p>為了想玩玩這個 project，我也想說投資一天來試看看翻不翻得動（因為在公司翻修同事的 code 有過非常豐富的經驗了，大概都知道 bad smell 在哪裡，如何在低 cost 狀態，把 code 整理到容易維護）。結論：翻修起來也不算是什麼難事，只是有點繁瑣而已。</p>

<p>總之，最後我終於把 code 整理的算差強人意，算讓人能容易加功能上去了…</p>

<p>看著看著總覺得又少點東西。想想大概是沒有 production data，要幫忙一些功能總是不知道要從哪裡起頭，加上這個站又沒有 test，幫忙翻修還是容易弄爛 master…</p>

<p>後來乾脆就決定了，來作一個 <a href="http://ruby-taiwan.org">http://ruby-taiwan.org</a>！</p>

<p>這個決定在推特宣布後，似乎有嚇到人，對岸朋友好幾個過來道德勸說我放棄這種行為 XDXD</p>

<p>其實不是什麼眼紅別人，自己也想搞一個多紅火的社群，而是說真的，我覺得台灣雖然玩 Ruby 的人開始變多，但會主動跑去大陸的論壇進行太熱烈的討論的機率太低了。加上用語、想法、習慣多多少少會有差距。現在台灣 Ruby 社群也算有點規模了…</p>

<p>沒想到我寶刀未老，原本只是隨便屁屁（我這個人的習慣是，有什麼新想法，就會先投資自己一點時間，可能是 1 天、3 天、1 週，先寫個 prototype 出來…如果寫不完，就是這個想法我並沒有想的清楚，或是我的技術不夠純熟到可以實作這個 idea。我必須馬上放棄這個想法，等待以後有機會再執行。反之，我就適合作這件事。）</p>

<p>一個晚上我竟然就搞定 deploy + i18n 翻修了。於是 <a href="http://ruby-taiwan.org">http://ruby-taiwan.org</a> 就誕生了！</p>

<p>為了怕初期沒什麼資料，怕沒人想用也沒人要發言。我在這個網站上有預先準備了自己以前從來沒有 release 出去過的一些教學文件。</p>

<p>…之後也會持續釋出更多東西。</p>

<p>首先是</p>

<ul>
<li><a href="http://wp.xdite.net/?p=2525">邁向 Rails 高級新手 – 你所需要知道的一些知識</a></li>
</ul>


<p>這篇提到的所有 topic 已經在 <a href="http://ruby-taiwan.org/wiki/essential-ruby-rails-knowledge">http://ruby-taiwan.org/wiki/essential-ruby-rails-knowledge</a> 這裡釋出了。（這裡面的內容是 <a href="http://www.techbang.com.tw">T 客邦</a> 技術部讓新人在訓練期寫的東西，主要是透過 Topic 導向讓新手知道怎樣使用這些東西，而且這裡選的 Topic 幾乎都已經是練完 Rails 101 之後接續開發產品，會碰到的各種基本知識）。大概有 30 幾篇文件。</p>

<ul>
<li><p>接下來是兩篇我以前沒公開放過的教學:</p>

<ul>
<li><a href="http://ruby-taiwan.org/wiki/custom-generators">Custom Generators</a></li>
<li><a href="http://ruby-taiwan.org/wiki/packing-gems">Packing Gems</a></li>
</ul>
</li>
<li><p>最後是 <a href="http://rails-101.logdown.com">Rails 101</a> 的第七章 <a href="http://ruby-taiwan.org/wiki/deploy_to_production_practice">遠端佈署最佳實踐</a>。教大家如何完美的佈署遠端 production server。</p></li>
</ul>


<p>歡迎大家有空上去<a href="http://ruby-taiwan.org/topics">多多交流</a>和完善補充自己的 pratices。以後我還會繼續把一些沒分享過的 pratices 繼續 release 出來。（相信我，多到嚇死人&#8230;）</p>

<p>最後，似乎是我改用 <a href="http://octopress.org">Octopress</a> 並撰文介紹這套 blogging system 後，引起非常熱烈的迴響，現在大家似乎都開始搬家轉用 Octopress…在這當中也出現了不少問題，我在 twitter 和社群聚會答了非常多相關問題。現在也決定在 Ruby Taiwan 上開一個 <a href="http://ruby-taiwan.org/topics/node24">Octopress 的節點主題</a> ，歡迎大家如果在用 Octopress 上如果遇到任何問題，都上來問，謝謝！</p>

  </div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/posts/2011/11/19/thouhgts-on-html5-and-mobile-app/">Thoughts on HTML5 & Mobile App</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2011-11-19T16:14:00+08:00" pubdate  data-updated="true" >Nov 19<span>th</span>, 2011</time>
        
         | <a href="/posts/2011/11/19/thouhgts-on-html5-and-mobile-app/#disqus_thread">Comments</a>
        

      </p>
    
  </header>


  <div class="entry-content">
    
      <div class="FacebookLikeButton"><div class="fb-like" data-href="http://blog.xdite.net/posts/2011/11/19/thouhgts-on-html5-and-mobile-app/" data-show-faces="false"></div></div>
    
    <p>這篇文章是看完陳鐘誠教授寫的「<a href="http://ccckmit.wikidot.com/in:htc">HTC 最需要的軟體能力</a>」的文章後，自己的感想。</p>

<p>坦白說，我真的覺得這是一篇相當天真的文章。</p>

<p>[在看下去之前，先警告讀者本文是一篇 TL;DR 的文章。]</p>

<h2>Thoughts on Flash</h2>

<p>上個禮拜網路界的熱門是，Adobe 宣布放棄了繼續在 Mobile Browser 上 Flash 的繼續開發（見 36kr 的 <a href="http://www.36kr.com/p/59728.html">有关Flash移动浏览器插件，Flash平台和Flash未来的几点澄清</a> ）。這篇文章提到幾件重要的事：</p>

<ol>
<li>mobile 版上的 flash 不可能完成 flash 在 desktop 上的規模偉業</li>
<li>HTML5 可以在 mobile browser 完成類似 flash 在 desktop browser 上能做出來的成果</li>
<li>使用者在 mobile device 上的閱讀的需求與體驗和 desktop 上有著很大的不同</li>
<li>mobile 版上的 flash plugin scabilty 不好 ( 這與硬體有很大的關係 )</li>
</ol>


<p>這時候，再回去看去年 Steve Jobs 當初寫的那一篇 <a href="http://www.techbang.com.tw/posts/2405-steve-jobs-thoughts-on-flash-full-translation">Thoughts on Flash</a>，儘管當時很多人罵 Steve Jobs 霸道，為了保護自己的商業利益、不惜故意扭曲放大 Flash 的缺點云云。</p>

<p>你不得不能說 Steve Jobs 其實當年其實是講了真話，這是「他看見的事實」。只是很多人「當時還沒有自己跳下來作，沒有那個深刻體會」，沒有辦法接受這個論點。</p>

<h3>mobile flash 致命的缺點</h3>

<p>如果你是蘋果的長期使用者的話，應該知道蘋果最 care 的其實不是賺錢，而是「<strong>使用者體驗</strong>」這件事。(別鞭我)</p>

<p>mobile flash 是個 container（iOS） 中的 container ( flash ) 這件事，其實沒什麼不好。就如同現在普遍的解決方案也是 container (iOS) 中的 container (HTML5 in Browser)。<strong> Flash 平台上就跟 HTML 一樣有著累積已久的解決方案和人才，不是 Native API 短期可以衝出來的。</strong></p>

<p>但 Flash 的缺陷就如同 Jobs 所說的一樣，無法解決或者是解決速度緩慢：</p>

<ol>
<li>Flash 無法夠流暢的在智慧型手機上運作。</li>
<li>Flash 在 Mobile 的版本幾乎要被重寫過，這件事情讓「累積方案」看起來沒有那麼值錢了。</li>
<li>使用者操作的行為不一樣。在 Desktop 上只有一種行為，也就是「滑鼠行為」。但 Mobile 上重要的是「手勢」。</li>
<li>耗電與效能問題。Flash 想作為 container 中的 container，但是要花費大量額外的人力去對硬體客製，否則無法達成目的。而耗電與效能正是智慧型手機上最被開發者和使用者所在乎的事情。</li>
<li>Native API 的支援。想要做到幫助開發者做到寫跨平台程式，平台支援 Native API 的速度至關重要，但 Adobe 這部分的速度慢的要死。</li>
</ol>


<p>所以 Jobs 才會在該篇文章的後面，這麼結語：「希望 Adobe 應該將焦點多放在製作 HTML5 的工具上」。我相信這是他的真心話。</p>

<h2>Thoughts on HTML5 &amp; Mobile App</h2>

<p>除了 Flash 之外，能夠解決「跨平台」這個目的的，就只剩下 HTML 這個方案了。</p>

<p>如果想在智慧型手機上開發軟體不那麼事倍功半的話，只有一個策略，那就是支援標準。</p>

<p>為什麼影音市場會傾向 H264，跨平台媒體方案會傾向 HTML5。因為「硬體」廠商和「OS」廠商會支援「標準」並可能實作「加速」，開發者就不需要那麼累的反而去對「每個平台」作客製。</p>

<p>有人打趣說寫 Mobile Web 真是愉快，因為開發者不需要像在 Desktop 的環境時，面對那麼多不同的 browser (特別是 IE6)。在智慧型手機上只有一種 browser，那就是 webkit-based。</p>

<h3>Mobile App 上的實戰</h3>

<p>前陣子自己實際寫了一套 Mobile 上的電子出版架構，更能深刻體悟到為何現在多數的工具型 App，其實都是 Native API 與 HTML5 混搭的策略。</p>

<ol>
<li>Native API 門檻太高。Native API 要練成絕世高手，絕非一朝一夕。但 mobile apps 的市場需求又遠超過開發者市場的供給。</li>
<li>HTML 上累積的解決方夠多。在 mobile apps 上介面上實作一段很絢麗的跳出框或特效，用 Native API 可能要刻上一週甚至更久。但是如果使用 jQuery 在 HTML 上實作就不用。</li>
<li>使用 HTML 的開發者夠多。撰寫 HTML 的門檻比起 Native API 門檻實在太低了，開發者容易培養訓練。</li>
</ol>


<h3>實質的解決方案：Titanium</h3>

<p><a href="http://www.appcelerator.com/">Titanium</a> 就是這樣的解決方案，簡介可見 <a href="http://www.inside.com.tw/2011/03/30/titanium-cross-platform-mobile-application-solution">跨平台移動應用程式的解決方案 – Titanium</a>。</p>

<p>多數的開發者的策略轉變成，以 Titanium 寫出符合 HIG 或者是 Mobile App Best Pratices 的原生介面（按鈕、流程），但媒體內容卻全以 HTML5 實作。</p>

<p>Titanium 主要的開發語言是 JavaScript，開發者可以透過 JavaScript 撰寫 function，交由 Titanium 轉換編譯成平台上的原生原始碼。</p>

<p>好處是：JavaScript 原本就是 Web Developer 平日使用的工具之一。開發者只要專心與 JavaScript / HTML / CSS 打交道即可，而它們都是「標準」。</p>

<p>這樣就可以將 Mobile App 的開發工作拆得更單純，讓 container 上的開發歸 container ( iOS )，媒體內容歸媒體內容。</p>

<h2>真正的決戰場在螢幕尺寸</h2>

<p>坦白說我看 「<a href="http://ccckmit.wikidot.com/in:htc">HTC 最需要的軟體能力</a>」此文，最難以理解的是這一段</p>

<blockquote>
更棒的是，程式設計師將不再需要為每一個平台撰寫一套程式，一個以 HTML5 為主的程式，可以同時在「iOS, Android, Windows」 等作業系統中執行，也可以跨越「手機、平板、筆電、桌電」等裝置的限制，成為名符其實的「Write Once, Run Anywhere !」的跨平台系統。
</blockquote>




<blockquote>
但是 HTML5 畢竟只是前端的顯示技術，這個技術並沒有制定出關於後端的標準，因此要能用 HTML5 統一「手機、平板、筆電、桌電」等裝置，仍然有一塊標準技術上的空白之地，而這塊領域也正是台灣廠商可以深耕的領域，這就是以 HTML5 為核心的伺服端技術。
</blockquote>




<blockquote>
這種伺服端技術不只可以用在傳統的桌上型電腦上，更可以直接用在「手機與平板」電腦當中，舉例而言，我們只要撰寫一個簡單的小型伺服器，放在手機上常駐執行，當 HTML5 網頁需要執行系統功能時，就用 AJAX 或 WebSocket 的方式，呼叫這些小型伺服器，以便執行系統功能，並且傳回系統相關的資訊，如此就能讓 HTML5 程式完成幾乎所有原本只有作業系統才能完成的功能，成為名符其實的「ＷebOS」。

</blockquote>


<p>What The H…</p>

<p>我不確定作者知不知道自己在說什麼？但 Mobile App 與 Desktop App，甚至是 Mobile Web 與 Desktop Web 上開發的挑戰根本不是 OS 的 API 問題。在不同平台上，使用者與平台互動機制與媒體的需求是完全不同的兩回事。</p>

<p>「Write Once, Run Anywhere !」沒什用，因為不能「Use」就沒有用。</p>

<p>Again：問題在於螢幕尺寸造成的 render 效果差異，和 device 不同的輸入互動模式。</p>

<h3>Responsive Design 不是終點</h3>

<p>對於螢幕尺寸造成的 render 效果差異，有人提出了「Responsive Design」這個概念。</p>

<p>Responsive design 是一個全新的設計概念，開發者可以使用 CSS3 的 media query ，去對不同 device 的寬度去對 HTML 作出不同的 styling。</p>

<p>很理想對吧？</p>

<p>我手上有兩個以上採 Responsive design 的 websites。還有一個採 Responsive design 的 mobile app。</p>

<p>實際開發出來進行維護（可以看 <a href="http://www.techbang.com.tw">T客邦</a> 和 <a href="http://digiphoto.techbang.com.tw">Digiphoto</a> ）才發現這也只是個理想國的概念。</p>

<p><strong>Responsive design 在 iPhone / iPad App 上的確很威，只要寫四套 CSS 就可以解決所有的問題。（iphone 直排/橫排, iPad 直排/橫排）</strong></p>

<p>有些開發者說，Mobile Web 上面沒有惡魔 IE6 了 YA!</p>

<p>錯了，真正的惡魔是 Android。</p>

<h4>Mobile 開發上的大惡魔：不同尺寸的 Android 手機與 Android 平板</h4>

<p>網頁開發者痛恨 IE 系列的原因是，明明寫的是正確的 CSS。但是 IE 就是會 render 出詭異的結果。</p>

<p>而不同尺寸的 Android 手機 / 平板，給開發者的惡夢就是：「無論你怎麼排版，View 就是會爆炸。」</p>

<p>今天在 Samsung 平版上看可能沒有問題，但是在 HTC 平板上，menu bar 可能就爆掉了。</p>

<p>使用者只會要求在它的 device 上的體驗要是完美的。</p>

<p>當然，PM 也不是沒有好心的告訴我一些他認為「可能」可以解決這樣問題的方案。比如砍字！</p>

<p>在 Flyer 上 menu 可以是「拍攝技法」、「哈燒新品」。但在 Sensation 上 menu 可以變成是「技法」、「新品」！</p>

<p>這是解法嗎？不是。Responsive 是提供 CSS styling 的解法，而砍字這個解法是要求我偵測 Agent 用程式去解決。(我知道可以用 responsive design 去另包元素作 display none; 我不可能配合，這是改動結構。因為使用者提出的需求不僅是這樣而已，還有加字、改 bar、改設計。簡直是瘋了。這樣偵測 Agent 重寫一版網頁版程式還比較快)</p>

<p>簡而言之，Responsive Design 遇到 device 的直排/橫排的情況是很棒的解法，但是它無法解決內容一直在變動，Device 尺寸不一的問題。</p>

<p>Desktop 瀏覽器視窗放大縮小造成破版的問題，使用者不會 Care，完全不是問題。但在 Mobile 瀏覽器上，這就是 Bug！</p>

<h2>螢幕的尺寸不一破壞了軟體生態圈</h2>

<p>這個世界已經漸漸告訴我們，智慧型手機的戰場不在於硬體規格，也不在於 OS 威不威。因為硬體和 OS 系統商「不可能自己做完任何事」。所以拼的就是軟體生態圈的品質。</p>

<p>消費者買智慧型手機，不是買 featues，而是想買「體驗良好」、「解決需求」的「app solutions」。</p>

<p>好的軟體生態圈才有辦法造出這些 solutions。</p>

<p>如何培育軟體生態圈？</p>

<p>其實開發者心聲多數相當單純：「少給我找麻煩」、「讓我可以賺到錢」，而不是「這技術門檻有多低」。</p>

<p>如果把開發者搞得半死不活，絕大精力都在處理硬體和 OS 製造出的愚蠢 bug。開發者也要吃飯，也要領錢，沒有人會願意餓著肚子陪你辦家家酒的。</p>

<p>而螢幕的尺寸不一就足夠把 Mobile App / Web Developer 搞垮</p>

<h2>小結</h2>

<p>其實不難規結，開發 Mobile App 的重點是什麼：</p>

<ol>
<li>流暢 (UI / Network Latency)、低耗能、高效率</li>
<li>支援標準</li>
<li>Native 與 HTML 技術混搭</li>
<li>固定螢幕尺寸</li>
<li>符合 <a href="http://developer.apple.com/library/ios/#documentation/userexperience/conceptual/mobilehig/Introduction/Introduction.html">HIG</a> 標竿的工藝</li>
<li>可以賺到錢</li>
</ol>


<p>HTML5 可以解決這當中的一些事情，如 (1) (2) (3)。但要做到「Write Once, Run Anywhere !」，跨越「手機、平板、筆電、桌電」等裝置的限制。看看目前的 Android 機海（4吋,7吋,10吋）情況，只能說算了吧…</p>

<p>而且這四種 Device 的需求原本就不同，HTML5 不是大靈丹。</p>

<p><a href="http://ccckmit.wikidot.com/in:htc">HTC 最需要的軟體能力</a> 是什麼？</p>

<p>我想絕對不會是往 HTML5 「微型伺服器」 這樣的方向，何況我也聽不太懂這是什麼東西。</p>

  </div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/posts/2011/11/19/omniauth-clean-auth-provider-3/">OmniAuth - 實作多方認證的最佳實踐 (3)</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2011-11-19T12:43:00+08:00" pubdate  data-updated="true" >Nov 19<span>th</span>, 2011</time>
        
         | <a href="/posts/2011/11/19/omniauth-clean-auth-provider-3/#disqus_thread">Comments</a>
        

      </p>
    
  </header>


  <div class="entry-content">
    
      <div class="FacebookLikeButton"><div class="fb-like" data-href="http://blog.xdite.net/posts/2011/11/19/omniauth-clean-auth-provider-3/" data-show-faces="false"></div></div>
    
    <p>OmniAuth 是在 2011/11/2 正式釋出 v1.0 版的，其實也就是不久之前而已…</p>

<p>這個大改版也讓我吃足苦頭，因為 0.3 與 1.0 的架構差太多，網路上 Google 到的文件反而會打爆我的 application，除錯了很久。</p>

<p>不過也因為這件事情，逼我在幾個小時之內認真看了不少關於認證的想法與文件，才從而理解這些架構，寫出這些文章&#8230;。</p>

<h2>0.3 與 1.0 的差異</h2>

<p>0.3 與 1.0 的差異，在於 1.0 的架構更直覺、更乾淨。主要改變有二：</p>

<ul>
<li>Strategy as Gem</li>
<li>標準的資料介面</li>
</ul>


<h3>Strategy as Gem</h3>

<p>在 0.3 版，如果開發者想在 Rails project 內使用 Twitter 的認證。除了必須在 Gemfile 內宣告使用 OmniAuth</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s2">&quot;omniauth&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>還必須使用一個 initializer 去 claim 他要使用 Twitter 認證</p>

<figure class='code'><figcaption><span>config/initializers/omniauth.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Builder</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">provider</span> <span class="ss">:twitter</span><span class="p">,</span> <span class="s1">&#39;CONSUMER_KEY&#39;</span><span class="p">,</span> <span class="s1">&#39;CONSUMER_SECRET&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>而在 1.0 中</p>

<p>開發者只需要這樣作，在 Gemfile 裡面宣稱他要使用 OmniAuth 和 OmniAuth-Twitter</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s2">&quot;omniauth&quot;</span>
</span><span class='line'><span class="n">gem</span> <span class="s2">&quot;omniauth-twitter&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>注意事項</h4>

<p>其實也是這個細微的差異，害我誤入歧途，我按照網路上找到的方案，也在 1.0 版乖乖多寫了一個 initializer 去宣告使用，反而造成 invalid credential。</p>

<h4>OAuth 惡夢</h4>

<p>當然將 Strategy 抽出來當成 Gem 是一件好事，這樣就不用因為某一個認證方 API 改版，就必須 fork 整個 OmniAuth 出來使用。</p>

<p>不過促使 OmniAuth 改版最痛的問題可能是 OAuth 的問題。</p>

<p>我也是因為實作 Github 的認證才發現到這個令人憤怒的 issue。</p>

<p>[BTW: <strong>講個不好笑的笑話，開發與 Github 結合的產品真的很令人困擾，因為你無法使用 &#8220;xxx github&#8221; 這樣的關鍵字在搜尋引擎找答案，因為結果一定會出現 xxx 在 Github 上的 repo。翻桌！=_=||| </strong>]</p>

<p>這是 OmniAuth 0.3 版當時的 <a href="https://github.com/intridea/omniauth/tree/3aff8a3d71a5c968f558172750a2a20165d77bc5/oa-oauth/lib/omniauth/strategies">oa-oauth</a> 目錄夾。你可以各家看到關於 OAuth 的認證實作多麼的混亂，逼得開發者只好寫出超多不同的 solution 去應對！</p>

<p>而 Github 雖然號稱已經<a href="https://github.com/blog/656-github-oauth2-support">支援 OAuth 2.0</a> (賀!?)，但令人崩潰的是，它也不是標準的。<a href="http://www.manning.com/katz/">Rails in Action</a> 作者 Ryan Bigg 在寫作此本書範例程式的認證部分時，曾經憤怒的發現這一個事實，並把故事始末紀錄在這篇文章「<a href="http://ryanbigg.com/2011/04/whodunit-devise-omniauth-oauth-or-github/">Whodunit: Devise, OmniAuth, OAuth or GitHub?
</a>」</p>

<p><strong>OAuth 2.0 的規格說，token param 必須命名為 oauth_token，而 Github 的卻叫作 access_token。</strong></p>

<p>而且 Github 不打算修這個問題…</p>

<p>所以如果在 0.3 版的 OmniAuth，你必須要 hack OAuth2 這個 gem 才能支援 Github&#8230;。而如果你同時要想支援 Facebook 認證，那就哭哭了 T_T</p>

<h4>小結</h4>

<p>而既然大家都這麼亂搞，不如把 Strategy 通通抽出來讓開發者在自己的黑箱內惡搞，可能還是比較快的一個方式&#8230;.</p>

<h3>標準的資料介面</h3>

<p>在 OmniAuth 拿資料的方式是存取 <code>env["omniauth.auth"]</code> 這個變數，裡面會回傳認證需要的參數與資訊。</p>

<p><a href="https://github.com/intridea/omniauth/tree/3aff8a3d71a5c968f558172750a2a20165d77bc5/oa-oauth/lib/omniauth/strategies/oauth">這個目錄</a> 含蓋了所有目前 OmniAuth 0.3 支援的 Strategy，可以看到大家的 auth_hash 通通都寫的不一樣，也是各自為政。</p>

<p>所以在 1.0 版，OmniAuth 將強迫大家走同樣的規格回來，這些使用者資訊將會切成四種 DSL methods : <code>info</code>, <code>uid</code>, <code>extra</code>, 和 <code>credentials</code>。</p>

<p>這個部分在<a href="http://dev-xdworks.dev/posts/2011/11/19/omniauth-clean-auth-provider-2/">上一篇</a>談架構時已經寫過，就不再重寫一遍了。</p>

<h2>小結</h2>

<p>經過這一番折騰，最後我還是成功用 OmniAuth 1.0 實作了 Github 認證。我將在下一節中示範如何整合。</p>

<p>但如果你還是想要用 0.3 實作 OmniAuth + Github 。我推薦你可以參考這篇 Stackoverflow 上的 <a href="http://stackoverflow.com/questions/5611023/github-oauth-using-devise-omniauth">GitHub OAuth using Devise + OmniAuth</a> 討論。</p>

<ul>
<li><p>Ryan Bigg 有個 <a href="http://github.com/rails3book/ticketee">ticketee</a> 的 project 可以參考。（我不保證它能動）</p></li>
<li><p>Markus Proske 也有個 <a href="http://github.com/markusproske/omniauth_pure">omniauth_pure</a> 的 project 可以看。</p></li>
</ul>


<p>Good Luck!</p>

  </div>
  
  


    </article>
  
  <nav class="pagination">
    <div>
      
        <a class="prev" href="/blog/page/10/">&larr; Older</a>
      
      <a href="/blog/archives">Blog Archives</a>
      
      <a class="next" href="/blog/page/8/">Newer &rarr;</a>
      
    </div>
  </nav>
</div>
<aside class="sidebar">
  
    <section>
  <h1> About</h1>
  
  <p>
    A software development blog by <a href="/author">xdite</a> &#8230;
  </p>
  
  <p><a href="http://feeds.feedburner.com/xxddite"><img src="http://feeds.feedburner.com/~fc/xxddite?bg=99CCFF&amp;fg=444444&amp;anim=1" height="26" width="88" style="border:0" alt="" /></a></p>
  

  <p><a href="http://twitter.com/xdite" class="twitter-follow-button">Follow @xdite</a><br />
  </p>
  
  <p><img src="/images/xdite-email.png"></p>
  
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/posts/2013/06/01/rails-101-in-rails4-and-ruby-2/">Rails 101 改版：支援 Rails 4 與 Ruby 2.0</a>
      </li>
    
      <li class="post">
        <a href="/posts/2013/05/20/jsdc-2013-slide/">Why F2E should learn Rails</a>
      </li>
    
      <li class="post">
        <a href="/posts/2013/05/19/one-assertion-per-test/">One assertion per test & DAMP not DRY</a>
      </li>
    
      <li class="post">
        <a href="/posts/2013/05/08/linode-hacked-htp/">Linode 被 Hack 事件始末</a>
      </li>
    
      <li class="post">
        <a href="/posts/2013/05/04/rails4-new-feature/">Rails 4: New Feature, Better Syntax</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/assetpipeline'>AssetPipeline (3)</a></li><li><a href='/blog/categories/boardgame'>BoardGame (1)</a></li><li><a href='/blog/categories/bookreviews'>BookReviews (4)</a></li><li><a href='/blog/categories/bootstrap'>Bootstrap (2)</a></li><li><a href='/blog/categories/coffeescript'>CoffeeScript (1)</a></li><li><a href='/blog/categories/css'>CSS (2)</a></li><li><a href='/blog/categories/git'>Git (2)</a></li><li><a href='/blog/categories/hosting'>Hosting (1)</a></li><li><a href='/blog/categories/html5'>HTML5 (1)</a></li><li><a href='/blog/categories/iphone'>iPhone (1)</a></li><li><a href='/blog/categories/markdown'>Markdown (1)</a></li><li><a href='/blog/categories/misc'>Misc (3)</a></li><li><a href='/blog/categories/mybook'>MyBook (5)</a></li><li><a href='/blog/categories/mycompany'>MyCompany (1)</a></li><li><a href='/blog/categories/octopress'>Octopress (3)</a></li><li><a href='/blog/categories/podcast'>Podcast (1)</a></li><li><a href='/blog/categories/projectmanagement'>ProjectManagement (6)</a></li><li><a href='/blog/categories/rails'>Rails (9)</a></li><li><a href='/blog/categories/railsconf'>RailsConf (3)</a></li><li><a href='/blog/categories/ruby'>Ruby (8)</a></li><li><a href='/blog/categories/rubygem'>Rubygem (10)</a></li><li><a href='/blog/categories/scss'>SCSS (3)</a></li><li><a href='/blog/categories/security'>Security (1)</a></li><li><a href='/blog/categories/seo'>SEO (1)</a></li><li><a href='/blog/categories/startup'>Startup (6)</a></li><li><a href='/blog/categories/tips'>Tips (16)</a></li><li><a href='/blog/categories/travel'>Travel (1)</a></li><li><a href='/blog/categories/webdesign'>WebDesign (5)</a></li></ul>
</section>

<section id="popularthreads" class="dsq-widget">
  <h2 class="dsq-widget-title">Popular Threads</h2>
  <script type="text/javascript" src="http://xdite-wp-blog.disqus.com/popular_threads_widget.js?num_items=5"></script>
</section>

<section id="recentcomments" class="dsq-widget">
  <h2 class="dsq-widget-title">Recent Comments</h2>
  <script type="text/javascript" src="http://xdite-wp-blog.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=24&excerpt_length=50"></script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("xdite", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/xdite" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @xdite</a>
  
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - xdite -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
    
      var disqus_shortname = 'xdite-wp-blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>


  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-537077-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>





</body>
</html>
